<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariscos GÃ³mez - Sistema de Inventario</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .github-badge {
            background: #24292e;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            display: inline-block;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #555;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab:hover {
            background: #ecf0f1;
        }

        .tab.active:hover {
            background: #2980b9;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9em;
            margin: 2px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .product-info {
            margin: 8px 0;
            color: #555;
        }

        .stock-low {
            color: #e74c3c;
            font-weight: bold;
        }

        .stock-ok {
            color: #27ae60;
            font-weight: bold;
        }

        .invoice-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .invoice-total {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #3498db;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            position: relative;
            z-index: 1000;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .date-filter {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
            align-items: end;
        }

        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
        }

        .sales-table th,
        .sales-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
            font-size: 0.9em;
        }

        .sales-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .sales-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .sales-table tbody tr:hover {
            background: #e3f2fd;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8em;
        }

        .login-info {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 0.9em;
            border: 1px solid #bbdefb;
        }

        .storage-monitor {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .storage-bar {
            background: rgba(255, 255, 255, 0.3);
            height: 8px;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .storage-fill {
            background: #27ae60;
            height: 100%;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .storage-fill.warning {
            background: #f39c12;
        }

        .storage-fill.danger {
            background: #e74c3c;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination button:disabled {
            background: #f8f9fa;
            color: #999;
            cursor: not-allowed;
        }

        .maintenance-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .maintenance-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: 'â³';
            animation: spin 2s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        /* Mejoras especÃ­ficas para mÃ³viles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 0;
            }
            
            .header {
                margin-bottom: 15px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                flex-direction: column;
                margin-bottom: 15px;
            }
            
            .tab {
                padding: 12px;
                font-size: 0.9em;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .product-card {
                padding: 15px;
            }

            .date-filter {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .user-info {
                position: static;
                margin-bottom: 15px;
                text-align: center;
                width: 100%;
                border-radius: 10px;
            }

            .login-container {
                margin: 20px auto;
                max-width: calc(100% - 20px);
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-number {
                font-size: 1.5em;
            }

            .maintenance-buttons {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 0.9em;
                margin: 3px;
            }

            .btn-sm {
                padding: 5px 10px;
                font-size: 0.8em;
            }

            .sales-table {
                font-size: 0.8em;
            }

            .sales-table th,
            .sales-table td {
                padding: 6px 8px;
            }

            .invoice-section {
                padding: 15px;
                margin: 15px 0;
            }

            .invoice-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 8px;
            }

            .invoice-total {
                font-size: 1.3em;
            }

            .form-group input,
            .form-group select,
            .search-box {
                font-size: 16px; /* Evita zoom en iOS */
            }

            .content {
                padding: 15px;
                border-radius: 10px;
            }

            .storage-monitor {
                font-size: 0.8em;
                padding: 12px;
            }

            .pagination {
                flex-wrap: wrap;
                gap: 5px;
            }

            .pagination button {
                padding: 6px 10px;
                font-size: 0.8em;
            }

            /* Grid para formularios de cliente */
            #invoice .content > div {
                display: block !important;
            }

            #invoice .content > div > div {
                margin-bottom: 20px;
            }

            /* Mejoras para la tabla de ventas en mÃ³vil */
            .table-wrapper {
                margin: 10px -15px;
            }

            .action-buttons {
                justify-content: center;
            }
        }

        /* Para pantallas muy pequeÃ±as */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            .header {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .content {
                padding: 10px;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .product-card {
                padding: 10px;
            }

            .product-name {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen">
        <div class="login-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">ð¦ Acceso al Sistema</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">ð¤ Usuario:</label>
                    <input type="text" id="username" required placeholder="Ingresa tu usuario">
                </div>
                <div class="form-group">
                    <label for="password">ð ContraseÃ±a:</label>
                    <input type="password" id="password" required placeholder="Ingresa tu contraseÃ±a">
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">ð Iniciar SesiÃ³n</button>
            </form>
            
            <div class="login-info">
                <strong>ð Credenciales de acceso:</strong><br>
                <strong>Usuarios Disponibles:</strong> Gomez, Jafeth, Diana<br>
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="hidden">
        <div class="user-info" id="userInfo">
            ð¤ Usuario: <span id="currentUser"></span>
            <button class="logout-btn" id="logoutBtn">ðª Salir</button>
        </div>

        <div class="container">
            <!-- Monitor de Almacenamiento -->
            <div class="storage-monitor" id="storageMonitor">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <span>ð¾ Uso de Almacenamiento: <span id="storageUsed">0</span>KB / <span id="storageLimit">5120</span>KB</span>
                    <span id="storagePercent">0%</span>
                </div>
                <div class="storage-bar">
                    <div class="storage-fill" id="storageFill"></div>
                </div>
                <div style="font-size: 0.8em; opacity: 0.9;">
                    ð <span id="totalRecords">0</span> registros totales â¢ 
                    ð·ï¸ <span id="totalProducts">0</span> productos â¢ 
                    ð <span id="totalInvoices">0</span> facturas
                </div>
            </div>

            <div class="header">
                <h1>ð¦ Mariscos GÃ³mez</h1>
                <p>Sistema de Inventario y FacturaciÃ³n</p>
                <div class="github-badge">ð± Jafeth CastellÃ³n GÃ³mez - Optimizado</div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="inventory">ð¦ Inventario</button>
                <button class="tab" data-tab="add-product">â Agregar Producto</button>
                <button class="tab" data-tab="invoice">ð§¾ FacturaciÃ³n</button>
                <button class="tab" data-tab="reports">ð Reportes</button>
                <button class="tab" data-tab="sales-reports">ð Reportes de Ventas</button>
                <button class="tab" data-tab="maintenance">ð§ Mantenimiento</button>
            </div>

            <!-- Inventario -->
            <div id="inventory" class="content">
                <h2>ð¦ Inventario de Productos</h2>
                <input type="text" class="search-box" id="searchProducts" placeholder="ð Buscar productos...">
                
                <!-- PaginaciÃ³n de productos -->
                <div class="pagination" id="productsPagination" style="display: none;">
                    <button onclick="changeProductPage(-1)">Â« Anterior</button>
                    <span id="productPageInfo">PÃ¡gina 1 de 1</span>
                    <button onclick="changeProductPage(1)">Siguiente Â»</button>
                </div>

                <div id="productGrid" class="product-grid"></div>
            </div>

            <!-- Agregar Producto -->
            <div id="add-product" class="content hidden">
                <h2>â Agregar Nuevo Producto</h2>
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="productName">Nombre del Producto:</label>
                        <input type="text" id="productName" required placeholder="Ej: Camarones Frescos">
                    </div>
                    <div class="form-group">
                        <label for="productCategory">CategorÃ­a:</label>
                        <select id="productCategory" required>
                            <option value="">Seleccionar categorÃ­a</option>
                            <option value="Pescados">Pescados</option>
                            <option value="Mariscos">Mariscos</option>
                            <option value="CrustÃ¡ceos">CrustÃ¡ceos</option>
                            <option value="Moluscos">Moluscos</option>
                            <option value="Productos Preparados">Productos Preparados</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Precio por Unidad/Kg (â¡):</label>
                        <input type="number" id="productPrice" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock Inicial:</label>
                        <input type="number" id="productStock" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="productUnit">Unidad de Medida:</label>
                        <select id="productUnit" required>
                            <option value="">Seleccionar unidad</option>
                            <option value="Kg">Kilogramos</option>
                            <option value="Lb">Libras</option>
                            <option value="Pza">Piezas</option>
                            <option value="Caja">Cajas</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">â Agregar Producto</button>
                </form>
            </div>

            <!-- FacturaciÃ³n -->
            <div id="invoice" class="content hidden">
                <h2>ð§¾ Sistema de FacturaciÃ³n</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>Datos del Cliente</h3>
                        <div class="form-group">
                            <label for="clientName">Nombre del Cliente:</label>
                            <input type="text" id="clientName" placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">TelÃ©fono:</label>
                            <input type="tel" id="clientPhone" placeholder="0000-0000">
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">DirecciÃ³n:</label>
                            <input type="text" id="clientAddress" placeholder="DirecciÃ³n completa">
                        </div>
                    </div>
                    <div>
                        <h3>Seleccionar Productos</h3>
                        <div class="form-group">
                            <label for="invoiceProduct">Producto:</label>
                            <select id="invoiceProduct">
                                <option value="">Seleccionar producto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="invoiceQuantity">Cantidad:</label>
                            <input type="number" id="invoiceQuantity" step="0.1" placeholder="0">
                        </div>
                        <button type="button" class="btn" id="addToInvoiceBtn">â Agregar al Pedido</button>
                    </div>
                </div>
                
                <div class="invoice-section">
                    <h3>ð Resumen del Pedido</h3>
                    <div id="invoiceItems"></div>
                    <div id="invoiceTotal" class="invoice-total">Total: â¡0.00</div>
                    <div class="action-buttons" style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" id="generatePDFBtn">ð Generar Factura PDF</button>
                        <button class="btn btn-danger" id="clearInvoiceBtn">ðï¸ Limpiar Pedido</button>
                    </div>
                </div>
            </div>

            <!-- Reportes -->
            <div id="reports" class="content hidden">
                <h2>ð Reportes y EstadÃ­sticas</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProductsStat">0</div>
                        <div>Total Productos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowStockProductsStat">0</div>
                        <div>Stock Bajo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">â¡<span id="totalInventoryValueStat">0</span></div>
                        <div>Valor Inventario</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalInvoicesStat">0</div>
                        <div>Facturas Generadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">â¡<span id="totalSalesStat">0</span></div>
                        <div>Total Vendido</div>
                    </div>
                </div>
            </div>

            <!-- Reportes de Ventas -->
            <div id="sales-reports" class="content hidden">
                <h2>ð Reportes Detallados de Ventas</h2>
                
                <div class="date-filter">
                    <div class="form-group">
                        <label for="startDate">ð Fecha Inicio:</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">ð Fecha Final:</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="action-buttons">
                        <button class="btn" id="filterSalesBtn">ð Filtrar</button>
                        <button class="btn btn-warning" id="clearFilterBtn">ðï¸ Limpiar</button>
                    </div>
                </div>

                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-success" id="exportPDFBtn">ð Exportar PDF</button>
                    <button class="btn btn-success" id="exportExcelBtn">ð Exportar Excel</button>
                    <button class="btn" id="printReportBtn">ð¨ï¸ Imprimir</button>
                </div>

                <div class="product-card">
                    <h3>ð Resumen del PerÃ­odo</h3>
                    <p><strong>Total de Ventas:</strong> â¡<span id="periodTotalSales">0.00</span></p>
                    <p><strong>Facturas en el PerÃ­odo:</strong> <span id="periodInvoiceCount">0</span></p>
                    <p><strong>Promedio por Factura:</strong> â¡<span id="averageInvoiceAmount">0.00</span></p>
                </div>

                <!-- PaginaciÃ³n para tabla de ventas -->
                <div class="pagination" id="salesPagination" style="display: none;">
                    <button onclick="changeSalesPage(-1)">Â« Anterior</button>
                    <span id="salesPageInfo">PÃ¡gina 1 de 1</span>
                    <button onclick="changeSalesPage(1)">Siguiente Â»</button>
                </div>

                <div class="table-wrapper">
                    <table class="sales-table" id="salesTable">
                        <thead>
                            <tr>
                                <th>ð # Factura</th>
                                <th>ð Fecha</th>
                                <th>ð Hora</th>
                                <th>ð¤ Cliente</th>
                                <th>ð TelÃ©fono</th>
                                <th>ð° Total</th>
                                <th>ð Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Nueva secciÃ³n de Mantenimiento -->
            <div id="maintenance" class="content hidden">
                <h2>ð§ Mantenimiento del Sistema</h2>
                
                <div class="maintenance-section">
                    <h3>ð Estado del Sistema</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="storageUsagePercent">0%</div>
                            <div>Almacenamiento Usado</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="oldRecordsCount">0</div>
                            <div>Registros Antiguos (>6 meses)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="systemPerformance">100%</div>
                            <div>Rendimiento del Sistema</div>
                        </div>
                    </div>
                </div>

                <div class="maintenance-section">
                    <h3>â ï¸ Alertas del Sistema</h3>
                    <div id="systemAlerts">
                        <!-- Las alertas se mostrarÃ¡n aquÃ­ dinÃ¡micamente -->
                    </div>
                </div>

                <div class="maintenance-section">
                    <h3>ð§¹ Limpieza AutomÃ¡tica</h3>
                    <p>El sistema puede limpiar automÃ¡ticamente datos antiguos para optimizar el rendimiento.</p>
                    <div class="maintenance-buttons">
                        <button class="btn btn-warning" onclick="archiveOldData()">ð¦ Archivar Datos Antiguos</button>
                        <button class="btn btn-success" onclick="exportAllData()">ð¾ Backup Completo</button>
                        <button class="btn btn-info" onclick="optimizeStorage()">â¡ Optimizar Almacenamiento</button>
                        <button class="btn btn-danger" onclick="clearOldInvoices()">ðï¸ Limpiar Facturas Antiguas</button>
                    </div>
                </div>

                <div class="maintenance-section">
                    <h3>ð ConfiguraciÃ³n de LÃ­mites</h3>
                    <div class="form-group">
                        <label for="maxInvoices">MÃ¡ximo de Facturas a Conservar:</label>
                        <input type="number" id="maxInvoices" value="1000" min="100" max="10000">
                        <small>Recomendado: 1000-2000 facturas</small>
                    </div>
                    <div class="form-group">
                        <label for="autoCleanupEnabled">
                            <input type="checkbox" id="autoCleanupEnabled"> 
                            Activar limpieza automÃ¡tica
                        </label>
                        <small>Limpia automÃ¡ticamente cuando el almacenamiento supera el 80%</small>
                    </div>
                    <button class="btn btn-success" onclick="saveMaintenanceConfig()">ð¾ Guardar ConfiguraciÃ³n</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        const users = {
            'Gomez': 'qwrt2107',
            'Jafeth': '290597',
            'Diana': 'qwrt2107'
        };

        let currentUser = null;
        let isLoggedIn = false;
        let products = JSON.parse(localStorage.getItem('mariscos_products') || '[]');
        let invoiceItems = [];
        let nextProductId = parseInt(localStorage.getItem('mariscos_next_id') || '1');
        let invoiceHistory = JSON.parse(localStorage.getItem('mariscos_invoices') || '[]');

        // Variables para paginaciÃ³n
        let currentProductPage = 1;
        let currentSalesPage = 1;
        const itemsPerPage = 12; // productos por pÃ¡gina
        const invoicesPerPage = 20; // facturas por pÃ¡gina

        // ConfiguraciÃ³n de mantenimiento
        let maintenanceConfig = JSON.parse(localStorage.getItem('mariscos_maintenance_config') || JSON.stringify({
            maxInvoices: 1000,
            autoCleanupEnabled: true,
            lastCleanup: null
        }));

        // FunciÃ³n para calcular uso de localStorage
        function getStorageUsage() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length + key.length;
                }
            }
            return Math.round(total / 1024); // KB
        }

        // FunciÃ³n para actualizar monitor de almacenamiento
        function updateStorageMonitor() {
            const used = getStorageUsage();
            const limit = 5120; // 5MB en KB
            const percentage = Math.round((used / limit) * 100);
            
            document.getElementById('storageUsed').textContent = used;
            document.getElementById('storageLimit').textContent = limit;
            document.getElementById('storagePercent').textContent = percentage + '%';
            document.getElementById('totalRecords').textContent = products.length + invoiceHistory.length;
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalInvoices').textContent = invoiceHistory.length;
            
            const fill = document.getElementById('storageFill');
            fill.style.width = percentage + '%';
            fill.className = 'storage-fill';
            
            if (percentage > 80) {
                fill.classList.add('danger');
                if (maintenanceConfig.autoCleanupEnabled) {
                    showStorageWarning();
                }
            } else if (percentage > 60) {
                fill.classList.add('warning');
            }
        }

        // FunciÃ³n para mostrar advertencia de almacenamiento
        function showStorageWarning() {
            if (getStorageUsage() > 4096) { // > 4MB
                showAlert('â ï¸ Almacenamiento casi lleno. Se recomienda realizar limpieza automÃ¡tica.', 'warning');
            }
        }

        // FunciÃ³n para mostrar alertas
        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const targetContainer = isLoggedIn ? 
                document.querySelector('#mainSystem .container') : 
                document.querySelector('.login-container');
            
            if (targetContainer) {
                if (isLoggedIn) {
                    targetContainer.insertBefore(alert, targetContainer.firstChild);
                } else {
                    targetContainer.appendChild(alert);
                }
                
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }

        // FunciÃ³n de login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (users[username] && users[username] === password) {
                currentUser = username;
                isLoggedIn = true;
                localStorage.setItem('current_user', currentUser);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                document.getElementById('currentUser').textContent = username;
                
                showAlert('â Inicio de sesiÃ³n exitoso', 'success');
                initializeSystem();
            } else {
                showAlert('â Usuario o contraseÃ±a incorrectos', 'danger');
            }
        }

        // FunciÃ³n de logout
        function handleLogout() {
            if (confirm('Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?')) {
                currentUser = null;
                isLoggedIn = false;
                localStorage.removeItem('current_user');
                
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainSystem').classList.add('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                clearInvoice();
            }
        }

        // FunciÃ³n para cambiar pestaÃ±as
        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            switch(tabName) {
                case 'inventory':
                    displayProducts();
                    break;
                case 'invoice':
                    updateInvoiceProductSelect();
                    break;
                case 'reports':
                    updateReports();
                    break;
                case 'sales-reports':
                    displaySalesReports();
                    break;
                case 'maintenance':
                    updateMaintenanceStats();
                    break;
            }
        }

        // FunciÃ³n para guardar productos
        function saveProducts() {
            localStorage.setItem('mariscos_products', JSON.stringify(products));
            localStorage.setItem('mariscos_next_id', nextProductId.toString());
            updateStorageMonitor();
        }

        // FunciÃ³n para guardar facturas
        function saveInvoices() {
            localStorage.setItem('mariscos_invoices', JSON.stringify(invoiceHistory));
            updateStorageMonitor();
        }

        // FunciÃ³n para mostrar productos con paginaciÃ³n
        function displayProducts() {
            const grid = document.getElementById('productGrid');
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            
            let filteredProducts = products;
            if (searchTerm) {
                filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm)
                );
            }

            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const startIndex = (currentProductPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);

            grid.innerHTML = '';
            
            if (pageProducts.length === 0) {
                grid.innerHTML = '<div class="product-card"><h3>ð¦ No hay productos</h3><p>Agrega productos usando la pestaÃ±a "Agregar Producto".</p></div>';
                document.getElementById('productsPagination').style.display = 'none';
                return;
            }
            
            pageProducts.forEach(product => {
                const stockClass = product.stock < 10 ? 'stock-low' : 'stock-ok';
                const stockIcon = product.stock < 10 ? 'â ï¸' : 'â';
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <div class="product-info">ð CategorÃ­a: ${product.category}</div>
                    <div class="product-info">ð° Precio: â¡${product.price.toLocaleString('es-CR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} / ${product.unit}</div>
                    <div class="product-info ${stockClass}">${stockIcon} Stock: ${product.stock} ${product.unit}</div>
                    <div class="action-buttons">
                        <button class="btn btn-sm" onclick="editProduct(${product.id})">âï¸ Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">ðï¸ Eliminar</button>
                    </div>
                `;
                grid.appendChild(productCard);
            });

            // Actualizar paginaciÃ³n
            if (totalPages > 1) {
                document.getElementById('productsPagination').style.display = 'flex';
                document.getElementById('productPageInfo').textContent = `PÃ¡gina ${currentProductPage} de ${totalPages}`;
                
                const prevBtn = document.querySelector('#productsPagination button:first-child');
                const nextBtn = document.querySelector('#productsPagination button:last-child');
                
                prevBtn.disabled = currentProductPage === 1;
                nextBtn.disabled = currentProductPage === totalPages;
            } else {
                document.getElementById('productsPagination').style.display = 'none';
            }
        }

        // FunciÃ³n para cambiar pÃ¡gina de productos
        function changeProductPage(direction) {
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            let filteredProducts = products;
            if (searchTerm) {
                filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm)
                );
            }
            
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            
            currentProductPage += direction;
            if (currentProductPage < 1) currentProductPage = 1;
            if (currentProductPage > totalPages) currentProductPage = totalPages;
            
            displayProducts();
        }

        // FunciÃ³n para buscar productos (mejorada)
        function searchProducts() {
            currentProductPage = 1; // Reiniciar a primera pÃ¡gina
            displayProducts();
        }

        // FunciÃ³n para agregar producto
        function handleAddProduct(event) {
            event.preventDefault();
            
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const unit = document.getElementById('productUnit').value;
            
            if (!name || !category || !price || !stock || !unit) {
                showAlert('â ï¸ Por favor completa todos los campos', 'danger');
                return;
            }
            
            // Verificar lÃ­mite de productos
            if (products.length >= 1000) {
                showAlert('â ï¸ LÃ­mite de productos alcanzado. Considera usar la funciÃ³n de mantenimiento.', 'warning');
                return;
            }
            
            const newProduct = {
                id: nextProductId++,
                name,
                category,
                price,
                stock,
                unit,
                createdAt: new Date().toISOString()
            };
            
            products.push(newProduct);
            saveProducts();
            
            document.getElementById('addProductForm').reset();
            showAlert('â Producto agregado exitosamente', 'success');
            showTab('inventory');
        }

        // FunciÃ³n para editar producto
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            const newPrice = prompt(`ð° Nuevo precio para ${product.name}:`, product.price);
            const newStock = prompt(`ð¦ Nuevo stock para ${product.name}:`, product.stock);
            
            if (newPrice !== null && newStock !== null) {
                product.price = parseFloat(newPrice) || product.price;
                product.stock = parseInt(newStock) || product.stock;
                product.updatedAt = new Date().toISOString();
                saveProducts();
                displayProducts();
                showAlert('â Producto actualizado exitosamente', 'success');
            }
        }

        // FunciÃ³n para eliminar producto
        function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            if (confirm(`Â¿EstÃ¡s seguro de que quieres eliminar "${product.name}"?\n\nEsta acciÃ³n no se puede deshacer.`)) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                displayProducts();
                showAlert('ðï¸ Producto eliminado exitosamente', 'success');
            }
        }

        // FunciÃ³n para actualizar select de productos en facturaciÃ³n
        function updateInvoiceProductSelect() {
            const select = document.getElementById('invoiceProduct');
            select.innerHTML = '<option value="">Seleccionar producto</option>';
            
            products.forEach(product => {
                if (product.stock > 0) {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - â¡${product.price.toLocaleString('es-CR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} / ${product.unit} (Stock: ${product.stock})`;
                    select.appendChild(option);
                }
            });
        }

        // FunciÃ³n para agregar producto a la factura
        function addToInvoice() {
            const productId = parseInt(document.getElementById('invoiceProduct').value);
            const quantity = parseFloat(document.getElementById('invoiceQuantity').value);
            
            if (!productId || !quantity || quantity <= 0) {
                showAlert('â ï¸ Por favor selecciona un producto y cantidad vÃ¡lida', 'danger');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (quantity > product.stock) {
                showAlert(`â ï¸ Stock insuficiente. Stock disponible: ${product.stock} ${product.unit}`, 'danger');
                return;
            }
            
            const existingItem = invoiceItems.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity + quantity > product.stock) {
                    showAlert(`â ï¸ Stock insuficiente. Stock disponible: ${product.stock} ${product.unit}`, 'danger');
                    return;
                }
                existingItem.quantity += quantity;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                invoiceItems.push({
                    productId,
                    name: product.name,
                    price: product.price,
                    quantity,
                    unit: product.unit,
                    total: product.price * quantity
                });
            }
            
            document.getElementById('invoiceProduct').value = '';
            document.getElementById('invoiceQuantity').value = '';
            
            updateInvoiceDisplay();
        }

        // FunciÃ³n para actualizar la visualizaciÃ³n de la factura
        function updateInvoiceDisplay() {
            const itemsContainer = document.getElementById('invoiceItems');
            const totalContainer = document.getElementById('invoiceTotal');
            
            itemsContainer.innerHTML = '';
            let total = 0;
            
            invoiceItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'invoice-item';
                itemDiv.innerHTML = `
                    <div>
                        <strong>${item.name}</strong><br>
                        ${item.quantity} ${item.unit} Ã â¡${item.price.toLocaleString('es-CR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                    <div>
                        â¡${item.total.toLocaleString('es-CR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        <button class="btn btn-danger btn-sm" onclick="removeFromInvoice(${index})">â</button>
                    </div>
                `;
                itemsContainer.appendChild(itemDiv);
                total += item.total;
            });
            
            totalContainer.textContent = `Total: â¡${total.toLocaleString('es-CR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // FunciÃ³n para remover item de la factura
        function removeFromInvoice(index) {
            if (confirm('Â¿Eliminar este producto de la factura?')) {
                invoiceItems.splice(index, 1);
                updateInvoiceDisplay();
                showAlert('ðï¸ Producto eliminado de la factura', 'success');
            }
        }

        // FunciÃ³n para limpiar factura
        function clearInvoice() {
            if (invoiceItems.length > 0 && !confirm('Â¿EstÃ¡s seguro de que quieres limpiar toda la factura?')) {
                return;
            }
            
            invoiceItems = [];
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            updateInvoiceDisplay();
            
            if (invoiceItems.length === 0) {
                showAlert('ðï¸ Factura limpiada', 'info');
            }
        }

        // FunciÃ³n para generar PDF de la factura
        function generateInvoicePDF() {
            if (invoiceItems.length === 0) {
                showAlert('â ï¸ No hay productos en la factura', 'danger');
                return;
            }
            
            // Verificar lÃ­mite de facturas
            if (invoiceHistory.length >= maintenanceConfig.maxInvoices) {
                if (confirm('Se ha alcanzado el lÃ­mite de facturas. Â¿Desea continuar? Se recomienda hacer limpieza de datos.')) {
                    // Continuar pero mostrar advertencia
                    showAlert('â ï¸ Sistema cerca del lÃ­mite. Visite la secciÃ³n de Mantenimiento.', 'warning');
                } else {
                    return;
                }
            }
            
            const clientName = document.getElementById('clientName').value || 'Cliente';
            const clientPhone = document.getElementById('clientPhone').value || 'N/A';
            const clientAddress = document.getElementById('clientAddress').value || 'N/A';
            
            const invoiceNumber = `FAC-${new Date().getFullYear()}-${String(invoiceHistory.length + 1).padStart(4, '0')}`;
            const now = new Date();
            
            // Actualizar stock
            invoiceItems.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    product.stock -= item.quantity;
                }
            });
            saveProducts();
            
            // Guardar factura
            const invoice = {
                number: invoiceNumber,
                date: now.toLocaleDateString('es-CR'),
                time: now.toLocaleTimeString('es-CR'),
                fullDateTime: now.toISOString(),
                client: { name: clientName, phone: clientPhone, address: clientAddress },
                items: [...invoiceItems],
                total: invoiceItems.reduce((sum, item) => sum + item.total, 0),
                user: currentUser
            };
            invoiceHistory.push(invoice);
            saveInvoices();
            
            // Generar PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('ð¦ Mariscos GÃ³mez', 20, 20);
            doc.setFontSize(12);
            doc.text('Sistema de FacturaciÃ³n', 20, 30);
            
            doc.text(`Fecha: ${invoice.date}`, 150, 20);
            doc.text(`Hora: ${invoice.time}`, 150, 30);
            doc.text(`Factura #${invoiceNumber}`, 150, 40);
            
            doc.setFontSize(14);
            doc.text('Datos del Cliente:', 20, 60);
            doc.setFontSize(11);
            doc.text(`Nombre: ${clientName}`, 20, 70);
            doc.text(`TelÃ©fono: ${clientPhone}`, 20, 80);
            doc.text(`DirecciÃ³n: ${clientAddress}`, 20, 90);
            
            doc.setFontSize(14);
            doc.text('Productos:', 20, 110);
            
            let y = 120;
            let total = 0;
            
            invoiceItems.forEach(item => {
                doc.setFontSize(10);
                doc.text(`${item.name}`, 20, y);
                doc.text(`${item.quantity} ${item.unit} Ã â¡${item.price.toLocaleString('es-CR')}`, 100, y);
                doc.text(`â¡${item.total.toLocaleString('es-CR')}`, 170, y);
                y += 10;
                total += item.total;
            });
            
            doc.setFontSize(14);
            doc.text(`TOTAL: â¡${total.toLocaleString('es-CR')}`, 150, y + 10);
            
            doc.setFontSize(10);
            doc.text('Â¡Gracias por su compra!', 20, y + 30);
            doc.text(`Atendido por: ${currentUser}`, 20, y + 40);
            
            doc.save(`factura_${clientName.replace(/\s+/g, '_')}_${invoiceNumber}.pdf`);
            
            showAlert('ð Factura PDF generada exitosamente', 'success');
            clearInvoice();
            updateInvoiceProductSelect();
            
            // Verificar si es necesario hacer limpieza automÃ¡tica
            if (maintenanceConfig.autoCleanupEnabled && getStorageUsage() > 4096) {
                setTimeout(() => {
                    if (confirm('El sistema ha detectado que el almacenamiento estÃ¡ casi lleno. Â¿Desea realizar una limpieza automÃ¡tica?')) {
                        optimizeStorage();
                    }
                }, 2000);
            }
        }

        // FunciÃ³n para actualizar reportes generales
        function updateReports() {
            const totalProductsCount = products.length;
            const lowStockProducts = products.filter(p => p.stock < 10).length;
            const totalValue = products.reduce((sum, product) => sum + (product.price * product.stock), 0);
            const totalInvoicesCount = invoiceHistory.length;
            const totalSales = invoiceHistory.reduce((sum, invoice) => sum + invoice.total, 0);
            
            document.getElementById('totalProductsStat').textContent = totalProductsCount;
            document.getElementById('lowStockProductsStat').textContent = lowStockProducts;
            document.getElementById('totalInventoryValueStat').textContent = totalValue.toLocaleString('es-CR', {minimumFractionDigits: 0});
            document.getElementById('totalInvoicesStat').textContent = totalInvoicesCount;
            document.getElementById('totalSalesStat').textContent = totalSales.toLocaleString('es-CR', {minimumFractionDigits: 0});
        }

        // FunciÃ³n para mostrar reportes de ventas con paginaciÃ³n
        function displaySalesReports() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            filterSales();
        }

        // FunciÃ³n para filtrar ventas
        function filterSales() {
            currentSalesPage = 1; // Reiniciar paginaciÃ³n
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filteredInvoices = [...invoiceHistory];
            
            if (startDate || endDate) {
                filteredInvoices = invoiceHistory.filter(invoice => {
                    const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                    const start = startDate ? new Date(startDate) : new Date('1900-01-01');
                    const end = endDate ? new Date(endDate + 'T23:59:59') : new Date('2100-12-31');
                    
                    return invoiceDate >= start && invoiceDate <= end;
                });
            }
            
            updateSalesTable(filteredInvoices);
            updatePeriodSummary(filteredInvoices);
        }

        // FunciÃ³n para cambiar pÃ¡gina de ventas
        function changeSalesPage(direction) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filteredInvoices = [...invoiceHistory];
            
            if (startDate || endDate) {
                filteredInvoices = invoiceHistory.filter(invoice => {
                    const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                    const start = startDate ? new Date(startDate) : new Date('1900-01-01');
                    const end = endDate ? new Date(endDate + 'T23:59:59') : new Date('2100-12-31');
                    
                    return invoiceDate >= start && invoiceDate <= end;
                });
            }
            
            const totalPages = Math.ceil(filteredInvoices.length / invoicesPerPage);
            
            currentSalesPage += direction;
            if (currentSalesPage < 1) currentSalesPage = 1;
            if (currentSalesPage > totalPages) currentSalesPage = totalPages;
            
            updateSalesTable(filteredInvoices);
            updatePeriodSummary(filteredInvoices);
        }

        // FunciÃ³n para limpiar filtros de fecha
        function clearDateFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            filterSales();
        }

        // FunciÃ³n para actualizar tabla de ventas con paginaciÃ³n
        function updateSalesTable(invoices) {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';
            
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay ventas en el perÃ­odo seleccionado</td></tr>';
                document.getElementById('salesPagination').style.display = 'none';
                return;
            }
            
            const totalPages = Math.ceil(invoices.length / invoicesPerPage);
            const startIndex = (currentSalesPage - 1) * invoicesPerPage;
            const endIndex = startIndex + invoicesPerPage;
            const pageInvoices = invoices.slice(startIndex, endIndex).reverse();
            
            pageInvoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.number}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.time || 'N/A'}</td>
                    <td>${invoice.client.name}</td>
                    <td>${invoice.client.phone}</td>
                    <td>â¡${invoice.total.toLocaleString('es-CR', {minimumFractionDigits: 2})}</td>
                    <td>
                        <button class="btn btn-sm" onclick="showInvoiceDetails('${invoice.number}')" title="Ver detalles">ðï¸</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.number}')" title="Eliminar factura">ðï¸</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Actualizar paginaciÃ³n
            if (totalPages > 1) {
                document.getElementById('salesPagination').style.display = 'flex';
                document.getElementById('salesPageInfo').textContent = `PÃ¡gina ${currentSalesPage} de ${totalPages}`;
                
                const prevBtn = document.querySelector('#salesPagination button:first-child');
                const nextBtn = document.querySelector('#salesPagination button:last-child');
                
                prevBtn.disabled = currentSalesPage === 1;
                nextBtn.disabled = currentSalesPage === totalPages;
            } else {
                document.getElementById('salesPagination').style.display = 'none';
            }
        }

        // FunciÃ³n para actualizar resumen del perÃ­odo
        function updatePeriodSummary(invoices) {
            const totalSales = invoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const invoiceCount = invoices.length;
            const averageAmount = invoiceCount > 0 ? totalSales / invoiceCount : 0;
            
            document.getElementById('periodTotalSales').textContent = totalSales.toLocaleString('es-CR', {minimumFractionDigits: 2});
            document.getElementById('periodInvoiceCount').textContent = invoiceCount;
            document.getElementById('averageInvoiceAmount').textContent = averageAmount.toLocaleString('es-CR', {minimumFractionDigits: 2});
        }

        // FunciÃ³n para mostrar detalles de factura
        function showInvoiceDetails(invoiceNumber) {
            const invoice = invoiceHistory.find(inv => inv.number === invoiceNumber);
            if (!invoice) return;
            
            let details = `ð Factura: ${invoice.number}\n`;
            details += `ð Fecha: ${invoice.date} ${invoice.time || ''}\n`;
            details += `ð¤ Cliente: ${invoice.client.name}\n`;
            details += `ð TelÃ©fono: ${invoice.client.phone}\n`;
            details += `ð DirecciÃ³n: ${invoice.client.address}\n\n`;
            details += `ð¦ Productos:\n`;
            
            invoice.items.forEach(item => {
                details += `â¢ ${item.name}: ${item.quantity} ${item.unit} Ã â¡${item.price.toLocaleString('es-CR')} = â¡${item.total.toLocaleString('es-CR')}\n`;
            });
            
            details += `\nð° Total: â¡${invoice.total.toLocaleString('es-CR')}`;
            if (invoice.user) {
                details += `\nð¤ Atendido por: ${invoice.user}`;
            }
            
            alert(details);
        }

        // Nueva funciÃ³n para eliminar factura
        function deleteInvoice(invoiceNumber) {
            const invoiceIndex = invoiceHistory.findIndex(inv => inv.number === invoiceNumber);
            if (invoiceIndex === -1) {
                showAlert('â ï¸ Factura no encontrada', 'danger');
                return;
            }
            
            const invoice = invoiceHistory[invoiceIndex];
            
            const confirmMessage = `â ï¸ ELIMINAR FACTURA\n\nFactura: ${invoice.number}\nCliente: ${invoice.client.name}\nTotal: â¡${invoice.total.toLocaleString('es-CR')}\nFecha: ${invoice.date}\n\nÂ¿EstÃ¡s seguro de eliminar esta factura?\n\nEsta acciÃ³n restaurarÃ¡ el stock de los productos vendidos y eliminarÃ¡ permanentemente la factura del sistema.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Restaurar stock de productos
            invoice.items.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    product.stock += item.quantity;
                    product.updatedAt = new Date().toISOString();
                }
            });
            
            // Eliminar factura del historial
            invoiceHistory.splice(invoiceIndex, 1);
            
            // Guardar cambios
            saveProducts();
            saveInvoices();
            
            showAlert(`â Factura ${invoice.number} eliminada exitosamente. Stock restaurado.`, 'success');
            
            // Actualizar la vista actual
            filterSales();
            updateReports();
        }

        // Funciones de exportaciÃ³n (mantenidas igual)
        function exportSalesToPDF() {
            const filteredInvoices = getFilteredInvoices();
            
            if (filteredInvoices.length === 0) {
                showAlert('â ï¸ No hay datos para exportar', 'danger');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Mariscos GÃ³mez', 20, 20);
            doc.setFontSize(14);
            doc.text('Reporte de Ventas', 20, 30);
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const periodText = startDate && endDate ? 
                `PerÃ­odo: ${startDate} a ${endDate}` : 
                'PerÃ­odo: Todas las ventas';
            
            doc.setFontSize(10);
            doc.text(periodText, 20, 40);
            doc.text(`Generado: ${new Date().toLocaleString('es-CR')}`, 20, 50);
            doc.text(`Por: ${currentUser}`, 20, 60);
            
            const totalSales = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
            doc.setFontSize(12);
            doc.text(`Total de Facturas: ${filteredInvoices.length}`, 20, 80);
            doc.text(`Total Vendido: â¡${totalSales.toLocaleString('es-CR')}`, 20, 90);
            
            const tableData = filteredInvoices.map(invoice => [
                invoice.number,
                invoice.date,
                invoice.time || 'N/A',
                invoice.client.name,
                `â¡${invoice.total.toLocaleString('es-CR')}`
            ]);
            
            doc.autoTable({
                head: [['# Factura', 'Fecha', 'Hora', 'Cliente', 'Total']],
                body: tableData,
                startY: 100,
                theme: 'striped',
                headStyles: { fillColor: [52, 152, 219] },
                styles: { fontSize: 8 }
            });
            
            const fileName = startDate && endDate ? 
                `reporte_ventas_${startDate}_${endDate}.pdf` : 
                `reporte_ventas_completo.pdf`;
            
            doc.save(fileName);
            showAlert('ð Reporte PDF exportado exitosamente', 'success');
        }

        function exportSalesToExcel() {
            const filteredInvoices = getFilteredInvoices();
            
            if (filteredInvoices.length === 0) {
                showAlert('â ï¸ No hay datos para exportar', 'danger');
                return;
            }
            
            const excelData = filteredInvoices.map(invoice => ({
                'NÃºmero de Factura': invoice.number,
                'Fecha': invoice.date,
                'Hora': invoice.time || 'N/A',
                'Cliente': invoice.client.name,
                'TelÃ©fono': invoice.client.phone,
                'DirecciÃ³n': invoice.client.address,
                'Total': invoice.total,
                'Atendido por': invoice.user || 'N/A'
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Reporte de Ventas');
            
            const summary = [
                ['RESUMEN DEL PERÃODO'],
                [''],
                ['Total de Facturas', filteredInvoices.length],
                ['Total Vendido', filteredInvoices.reduce((sum, inv) => sum + inv.total, 0)],
                ['Promedio por Factura', filteredInvoices.length > 0 ? filteredInvoices.reduce((sum, inv) => sum + inv.total, 0) / filteredInvoices.length : 0],
                [''],
                ['Generado por', currentUser],
                ['Fecha de generaciÃ³n', new Date().toLocaleString('es-CR')]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Resumen');
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const fileName = startDate && endDate ? 
                `reporte_ventas_${startDate}_${endDate}.xlsx` : 
                `reporte_ventas_completo.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            showAlert('ð Reporte Excel exportado exitosamente', 'success');
        }

        function printSalesReport() {
            const filteredInvoices = getFilteredInvoices();
            
            if (filteredInvoices.length === 0) {
                showAlert('â ï¸ No hay datos para imprimir', 'danger');
                return;
            }
            
            window.print();
        }

        function getFilteredInvoices() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate && !endDate) {
                return [...invoiceHistory].reverse();
            }
            
            return invoiceHistory.filter(invoice => {
                const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                const start = startDate ? new Date(startDate) : new Date('1900-01-01');
                const end = endDate ? new Date(endDate + 'T23:59:59') : new Date('2100-12-31');
                
                return invoiceDate >= start && invoiceDate <= end;
            }).reverse();
        }

        // Nuevas funciones de mantenimiento
        function updateMaintenanceStats() {
            const storageUsage = getStorageUsage();
            const storageLimit = 5120;
            const percentage = Math.round((storageUsage / storageLimit) * 100);
            
            // Calcular registros antiguos (mÃ¡s de 6 meses)
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const oldInvoices = invoiceHistory.filter(invoice => {
                const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                return invoiceDate < sixMonthsAgo;
            });
            
            // Calcular rendimiento del sistema basado en cantidad de datos
            let performance = 100;
            if (products.length > 500) performance -= 10;
            if (invoiceHistory.length > 1000) performance -= 15;
            if (storageUsage > 3000) performance -= 20;
            if (storageUsage > 4000) performance -= 30;
            
            document.getElementById('storageUsagePercent').textContent = percentage + '%';
            document.getElementById('oldRecordsCount').textContent = oldInvoices.length;
            document.getElementById('systemPerformance').textContent = Math.max(performance, 0) + '%';
            
            // Actualizar alertas del sistema
            updateSystemAlerts(percentage, oldInvoices.length, performance);
            
            // Cargar configuraciÃ³n
            document.getElementById('maxInvoices').value = maintenanceConfig.maxInvoices;
            document.getElementById('autoCleanupEnabled').checked = maintenanceConfig.autoCleanupEnabled;
        }

        function updateSystemAlerts(storagePercent, oldRecordsCount, performance) {
            const alertsContainer = document.getElementById('systemAlerts');
            alertsContainer.innerHTML = '';
            
            const alerts = [];
            
            if (storagePercent > 80) {
                alerts.push({
                    type: 'danger',
                    message: 'â ï¸ Almacenamiento crÃ­tico (>80%). Se requiere limpieza inmediata.',
                    action: 'optimizeStorage'
                });
            } else if (storagePercent > 60) {
                alerts.push({
                    type: 'warning',
                    message: 'â ï¸ Almacenamiento alto (>60%). Considera hacer limpieza.',
                    action: 'optimizeStorage'
                });
            }
            
            if (oldRecordsCount > 100) {
                alerts.push({
                    type: 'info',
                    message: `ð ${oldRecordsCount} facturas antiguas pueden ser archivadas.`,
                    action: 'archiveOldData'
                });
            }
            
            if (performance < 70) {
                alerts.push({
                    type: 'warning',
                    message: 'ð Rendimiento del sistema reducido. Se recomienda optimizaciÃ³n.',
                    action: 'optimizeStorage'
                });
            }
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="alert alert-success">â Sistema funcionando correctamente</div>';
                return;
            }
            
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.type}`;
                alertDiv.innerHTML = `
                    ${alert.message}
                    <button class="btn btn-sm" onclick="${alert.action}()" style="margin-left: 10px; padding: 5px 10px;">Resolver</button>
                `;
                alertsContainer.appendChild(alertDiv);
            });
        }

        function archiveOldData() {
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const oldInvoices = invoiceHistory.filter(invoice => {
                const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                return invoiceDate < sixMonthsAgo;
            });
            
            if (oldInvoices.length === 0) {
                showAlert('â¹ï¸ No hay facturas antiguas para archivar', 'info');
                return;
            }
            
            if (!confirm(`Â¿Desea archivar ${oldInvoices.length} facturas antiguas? Se exportarÃ¡n a Excel antes de eliminarlas.`)) {
                return;
            }
            
            // Exportar datos antiguos
            const ws = XLSX.utils.json_to_sheet(oldInvoices.map(invoice => ({
                'NÃºmero de Factura': invoice.number,
                'Fecha': invoice.date,
                'Hora': invoice.time || 'N/A',
                'Cliente': invoice.client.name,
                'TelÃ©fono': invoice.client.phone,
                'DirecciÃ³n': invoice.client.address,
                'Total': invoice.total,
                'Atendido por': invoice.user || 'N/A'
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Facturas Archivadas');
            
            const fileName = `archivo_facturas_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // Remover facturas antiguas
            invoiceHistory = invoiceHistory.filter(invoice => {
                const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                return invoiceDate >= sixMonthsAgo;
            });
            
            saveInvoices();
            showAlert(`â ${oldInvoices.length} facturas archivadas y exportadas exitosamente`, 'success');
            updateMaintenanceStats();
        }

        function exportAllData() {
            const wb = XLSX.utils.book_new();
            
            // Hoja de productos
            const productsWs = XLSX.utils.json_to_sheet(products);
            XLSX.utils.book_append_sheet(wb, productsWs, 'Productos');
            
            // Hoja de facturas
            const invoicesData = invoiceHistory.map(invoice => ({
                'NÃºmero': invoice.number,
                'Fecha': invoice.date,
                'Hora': invoice.time || 'N/A',
                'Cliente': invoice.client.name,
                'TelÃ©fono': invoice.client.phone,
                'DirecciÃ³n': invoice.client.address,
                'Total': invoice.total,
                'Usuario': invoice.user || 'N/A'
            }));
            const invoicesWs = XLSX.utils.json_to_sheet(invoicesData);
            XLSX.utils.book_append_sheet(wb, invoicesWs, 'Facturas');
            
            // Hoja de resumen
            const summary = [
                ['BACKUP COMPLETO - MARISCOS GÃMEZ'],
                [''],
                ['Fecha de backup', new Date().toLocaleString('es-CR')],
                ['Usuario', currentUser],
                [''],
                ['ESTADÃSTICAS'],
                ['Total productos', products.length],
                ['Total facturas', invoiceHistory.length],
                ['Uso de almacenamiento (KB)', getStorageUsage()],
                [''],
                ['CONFIGURACIÃN'],
                ['MÃ¡ximo facturas', maintenanceConfig.maxInvoices],
                ['Limpieza automÃ¡tica', maintenanceConfig.autoCleanupEnabled ? 'Habilitada' : 'Deshabilitada']
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'InformaciÃ³n');
            
            const fileName = `backup_completo_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showAlert('ð¾ Backup completo exportado exitosamente', 'success');
        }

        function optimizeStorage() {
            const initialUsage = getStorageUsage();
            
            // Limpiar datos duplicados y optimizar estructura
            const uniqueProducts = [];
            const productNames = new Set();
            
            products.forEach(product => {
                const key = `${product.name}-${product.category}`;
                if (!productNames.has(key)) {
                    productNames.add(key);
                    uniqueProducts.push(product);
                }
            });
            
            const removedProducts = products.length - uniqueProducts.length;
            products = uniqueProducts;
            
            // Optimizar facturas eliminando campos innecesarios
            invoiceHistory = invoiceHistory.map(invoice => ({
                number: invoice.number,
                date: invoice.date,
                time: invoice.time,
                fullDateTime: invoice.fullDateTime,
                client: invoice.client,
                items: invoice.items.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    unit: item.unit,
                    total: item.total
                })),
                total: invoice.total,
                user: invoice.user
            }));
            
            saveProducts();
            saveInvoices();
            
            const finalUsage = getStorageUsage();
            const saved = initialUsage - finalUsage;
            
            showAlert(`â¡ OptimizaciÃ³n completada. Espacio liberado: ${saved}KB. Productos duplicados removidos: ${removedProducts}`, 'success');
            updateStorageMonitor();
            updateMaintenanceStats();
        }

        function clearOldInvoices() {
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            
            const oldInvoices = invoiceHistory.filter(invoice => {
                const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                return invoiceDate < threeMonthsAgo;
            });
            
            if (oldInvoices.length === 0) {
                showAlert('â¹ï¸ No hay facturas antiguas para eliminar', 'info');
                return;
            }
            
            if (!confirm(`â ï¸ ADVERTENCIA: Esta acciÃ³n eliminarÃ¡ permanentemente ${oldInvoices.length} facturas de mÃ¡s de 3 meses. Â¿Continuar?`)) {
                return;
            }
            
            const totalSalesRemoved = oldInvoices.reduce((sum, inv) => sum + inv.total, 0);
            
            invoiceHistory = invoiceHistory.filter(invoice => {
                const invoiceDate = new Date(invoice.fullDateTime || invoice.date);
                return invoiceDate >= threeMonthsAgo;
            });
            
            saveInvoices();
            showAlert(`ðï¸ ${oldInvoices.length} facturas eliminadas (â¡${totalSalesRemoved.toLocaleString('es-CR')} en ventas)`, 'success');
            updateMaintenanceStats();
        }

        function saveMaintenanceConfig() {
            const maxInvoices = parseInt(document.getElementById('maxInvoices').value);
            const autoCleanupEnabled = document.getElementById('autoCleanupEnabled').checked;
            
            if (maxInvoices < 100 || maxInvoices > 10000) {
                showAlert('â ï¸ El lÃ­mite de facturas debe estar entre 100 y 10,000', 'danger');
                return;
            }
            
            maintenanceConfig = {
                maxInvoices,
                autoCleanupEnabled,
                lastCleanup: new Date().toISOString()
            };
            
            localStorage.setItem('mariscos_maintenance_config', JSON.stringify(maintenanceConfig));
            showAlert('ð¾ ConfiguraciÃ³n de mantenimiento guardada', 'success');
            updateMaintenanceStats();
        }

        // FunciÃ³n para inicializar el sistema
        function initializeSystem() {
            updateStorageMonitor();
            displayProducts();
            updateReports();
            
            // Verificar si es necesaria limpieza automÃ¡tica al inicio
            if (maintenanceConfig.autoCleanupEnabled && getStorageUsage() > 4096) {
                setTimeout(() => {
                    showAlert('ð§ Sistema requiere optimizaciÃ³n. Visite la secciÃ³n de Mantenimiento.', 'warning');
                }, 3000);
            }
        }

        // FunciÃ³n para verificar sesiÃ³n automÃ¡tica
        function checkAutoLogin() {
            const savedUser = localStorage.getItem('current_user');
            if (savedUser && users[savedUser]) {
                currentUser = savedUser;
                isLoggedIn = true;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                document.getElementById('currentUser').textContent = savedUser;
                initializeSystem();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar configuraciÃ³n de mantenimiento
            maintenanceConfig = JSON.parse(localStorage.getItem('mariscos_maintenance_config') || JSON.stringify({
                maxInvoices: 1000,
                autoCleanupEnabled: true,
                lastCleanup: null
            }));
            
            checkAutoLogin();
            
            // Event listeners para el login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Event listeners para las pestaÃ±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    showTab(this.dataset.tab);
                });
            });
            
            // Event listeners para productos
            document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
            document.getElementById('searchProducts').addEventListener('keyup', searchProducts);
            
            // Event listeners para facturaciÃ³n
            document.getElementById('addToInvoiceBtn').addEventListener('click', addToInvoice);
            document.getElementById('generatePDFBtn').addEventListener('click', generateInvoicePDF);
            document.getElementById('clearInvoiceBtn').addEventListener('click', clearInvoice);
            
            // Event listeners para reportes de ventas
            document.getElementById('filterSalesBtn').addEventListener('click', filterSales);
            document.getElementById('clearFilterBtn').addEventListener('click', clearDateFilter);
            document.getElementById('exportPDFBtn').addEventListener('click', exportSalesToPDF);
            document.getElementById('exportExcelBtn').addEventListener('click', exportSalesToExcel);
            document.getElementById('printReportBtn').addEventListener('click', printSalesReport);
            
            // Actualizar monitor de almacenamiento cada 30 segundos
            setInterval(updateStorageMonitor, 30000);
        });
    </script>
</body>
</html>